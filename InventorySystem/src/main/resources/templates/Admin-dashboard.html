<!DOCTYPE html>
<html lang="en">
  <head th:replace="~{fragments/Head::head}">
    <body>
      <div th:replace="~{fragments/Navbar::admin-navbar}"></div>
      <script th:replace="~{fragments/Scripts::script1}"></script>
      <script th:replace="~{fragments/Scripts::script3}"></script>
      <script th:replace="~{fragments/Scripts::script2}"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <!-- Container -->
      <div class="container my-5">
        <h1 class="display-4 text-center mb-4">Admin Dashboard</h1>

        <!-- Orders Card -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title mb-4">Orders Overview</h3>
            <form id="monthForm">
              <div class="row g-3">
                <!-- Start Month Selector -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="startMonth" class="form-label">Start Month</label>
                    <select id="startMonth" class="form-select form-select-lg">
                      <option value="1" selected>January</option>
                      <option value="2">February</option>
                      <option value="3">March</option>
                      <option value="4">April</option>
                      <option value="5">May</option>
                      <option value="6">June</option>
                      <option value="7">July</option>
                      <option value="8">August</option>
                      <option value="9">September</option>
                      <option value="10">October</option>
                      <option value="11">November</option>
                      <option value="12">December</option>
                    </select>
                  </div>
                </div>

                <!-- End Month Selector -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="endMonth" class="form-label">End Month</label>
                    <select id="endMonth" class="form-select form-select-lg">
                      <option value="1">January</option>
                      <option value="2">February</option>
                      <option value="3">March</option>
                      <option value="4">April</option>
                      <option value="5">May</option>
                      <option value="6">June</option>
                      <option value="7">July</option>
                      <option value="8">August</option>
                      <option value="9">September</option>
                      <option value="10">October</option>
                      <option value="11">November</option>
                      <option value="12" selected>December</option>
                    </select>
                  </div>
                </div>
              </div>
              <!-- Update Button -->
              <div class="text-center mt-4">
                <button onclick="updateChart()" type="button" class="btn btn-lg btn-primary rounded-pill px-5">
                  Update Chart
                </button>
              </div>
            </form>

            <!-- Loader -->
            <div id="loader" class="text-center my-4" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>

            <!-- Chart -->
            <canvas id="orderChart" class="mt-5"></canvas>
          </div>
        </div>
      </div>

      <div th:replace="~{fragments/Footer::admin-footer}"></div>

      <script>
        // Fetch data and render chart after DOM is loaded
        document.addEventListener("DOMContentLoaded", function () {
          showLoader(true);
          fetch("/admin/monthly-orders", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              showLoader(false);
              renderChart(data);
            })
            .catch((error) => {
              console.error("Error:", error);
              showLoader(false);
            });
        });

        const monthlyOrders = {
          labels: [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ],
          orderData: [],
        };

        const ordersCtx = document.getElementById("orderChart").getContext("2d");
        const orderChart = new Chart(ordersCtx, {
          type: "line",
          data: {
            labels: monthlyOrders.labels,
            datasets: [
              {
                label: "Orders",
                data: monthlyOrders.orderData,
                borderColor: "rgb(75, 192, 192)",
                fill: false,
                pointBackgroundColor: "#007bff",
                pointRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: "Monthly Orders",
            },
            scales: {
              xAxes: [
                {
                  scaleLabel: {
                    display: true,
                    labelString: "Month",
                  },
                },
              ],
              yAxes: [
                {
                  scaleLabel: {
                    display: true,
                    labelString: "Value",
                  },
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
          },
        });

        function renderChart(data) {
          for (let i = 1; i <= 12; i++) {
            var matched = false;
            data.forEach((item) => {
              if (i == item.month) {
                matched = true;
                monthlyOrders.orderData.push(item.numberOfOrders);
              }
            });
            if (!matched) {
              monthlyOrders.orderData.push(0);
            }
          }
          updateChart();
        }

        function updateChart() {
          const startMonthSelect = document.getElementById("startMonth");
          const endMonthSelect = document.getElementById("endMonth");

          const startMonthIndex = startMonthSelect.value - 1;
          const endMonthIndex = endMonthSelect.value - 1;

          if (startMonthIndex > endMonthIndex) {
            alert("End Month should be greater than Start Month");
            return;
          }

          orderChart.data.labels = monthlyOrders.labels.slice(
            startMonthIndex,
            endMonthIndex + 1
          );
          orderChart.data.datasets[0].data = monthlyOrders.orderData.slice(
            startMonthIndex,
            endMonthIndex + 1
          );

          orderChart.update();
        }

        function showLoader(visible) {
          const loader = document.getElementById("loader");
          loader.style.display = visible ? "block" : "none";
        }
      </script>
    </body>
  </head>
</html>
